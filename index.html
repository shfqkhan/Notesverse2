import tkinter as tk
from tkinter import ttk
from PIL import Image, ImageDraw, ImageFont, ImageTk
import numpy as np
import easyocr
import threading
import time

# Initialize EasyOCR reader (English only)
reader = easyocr.Reader(['en'])

class RealTimeHandwritingApp:
    def _init_(self, root):
        self.root = root
        self.root.title("Real-Time Handwriting to Font Converter")

        # Drawing canvas
        self.canvas = tk.Canvas(root, width=500, height=200, bg='white')
        self.canvas.pack(pady=10)
        self.canvas.bind("<B1-Motion>", self.paint)

        # Font selection
        self.font_var = tk.StringVar(value="Arial")
        self.font_dropdown = ttk.Combobox(root, textvariable=self.font_var)
        self.font_dropdown['values'] = sorted(["Arial", "Helvetica", "Times New Roman", "Courier", "Comic Sans MS", "Verdana"])
        self.font_dropdown.pack()

        # Label to display recognized text
        self.text_label = tk.Label(root, text="", font=(self.font_var.get(), 24))
        self.text_label.pack(pady=10)

        # PIL image for capturing canvas strokes
        self.image = Image.new("L", (500, 200), color=255)
        self.draw = ImageDraw.Draw(self.image)

        # Flag to stop the OCR thread
        self.running = True

        # Start the OCR thread
        self.thread = threading.Thread(target=self.ocr_loop)
        self.thread.daemon = True
        self.thread.start()

    def paint(self, event):
        """Draw on canvas and PIL image"""
        x1, y1 = (event.x - 3), (event.y - 3)
        x2, y2 = (event.x + 3), (event.y + 3)
        self.canvas.create_oval(x1, y1, x2, y2, fill='black', width=5)
        self.draw.ellipse([x1, y1, x2, y2], fill=0)

    def ocr_loop(self):
        """Continuously recognize handwriting in the background"""
        while self.running:
            # Convert PIL image to numpy array
            img_array = np.array(self.image)
            # Use EasyOCR to read text
            result = reader.readtext(img_array)
            text = " ".join([res[1] for res in result])
            
            # Update label text and font
            self.text_label.config(text=text, font=(self.font_var.get(), 24))
            time.sleep(1)  # Update every second for real-time effect

    def stop(self):
        """Stop the background OCR thread"""
        self.running = False
        self.thread.join()

# Initialize the Tkinter app
root = tk.Tk()
app = RealTimeHandwritingApp(root)

# Properly handle closing the app
def on_close():
    app.stop()
    root.destroy()

root.protocol("WM_DELETE_WINDOW", on_close)
root.mainloop()
